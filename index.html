<!DOCTYPE html>
<html>
  <head>
    <title>PLANTS HUMANS ROBOTS</title>
    <meta charset="utf-8">
    
    <!-- >>>>>STYLESHEETS<<<<< -->
    <link href="gmuStyle.css" rel="stylesheet" type="text/css">
    
    <!-- >>>>>BOOTSTRAP SCRIPTS<<<<< -->
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery.js"></script>
    
    <!-- >>>>>D3 SCRIPTS<<<<< -->
    <script type="text/javascript" src="d3/d3.js"></script>
    
    <!-- >>>>>own SCRIPTS<<<<< 
    <script type="text/javascript" src="gmuModel.js"></script>
    <script type="text/javascript" src="gmuView.js"></script>
    <script type="text/javascript" src="gmuController.js"></script>
    <script type="text/javascript" src="gmuStart.js"></script>
    -->
  </head>
  <body>
    <div id="gmuArt">
      <div id="gmuPlant">
      </div>
      <div id="gmuGrid">
      </div>
      
    </div>
    <script type="text/javascript">

      //constants
      var padding = 10
      var w = window.innerWidth - padding;
      var h = window.innerHeight- padding;
      var rect_count = 500;
      var grid_data = new Array();
      var rect_opacity = 0.2;

      var branches = 10;
      var branch_length = 200;
      var branch_queue = new Array();
      var sub_branch = 4;
      var max_sub_angle = 3*Math.PI/4 ;
      var max_size = 8 ;
      var plant_data = new Array();
      var branch_count = 0;
      var plantContainer = d3.select("#gmuPlant")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

      init_plant();
      grow_plant();
      
      //init_grid(rect_count);
      //draw_grid();

      function init_grid(r_count){
        var _cols = Math.round(Math.sqrt(r_count * (w/h)));
        var _rows = Math.round(r_count / _cols);

        var _r_w = w / _cols; // calc width of rects
        var _r_h = h / _rows; // calc height of rects

        var idx = 0;
        for(var r = 0; r < _rows; r++){
          for(var c = 0; c < _cols ; c++){
            grid_data[idx] = new Object();
            grid_data[idx]["id"]      = idx;
            grid_data[idx]["width"]   = _r_w;
            grid_data[idx]["pos_y"]   = _r_h * r;
            grid_data[idx]["height"]  = _r_h;
            grid_data[idx]["pos_x"]   = _r_w * c;
            grid_data[idx]["touched"] = 0;
            idx++;
          }
        }
        //alert(idx-1);
      }

      function draw_grid(){
        var gridContainer = d3.select("#gmuGrid")
          .append("svg")
          .attr("width", w)
          .attr("height", h);

        var rectGrid = gridContainer.selectAll("rect")
          .data(grid_data)
          .enter()
          .append("rect");

        rectGrid.attr("id", function(d,i){return "r"+i;})
          .attr("x", function(d,i){return grid_data[i].pos_x})
          .attr("y", function(d,i){return grid_data[i].pos_y})
          .attr("width", function(d,i){return grid_data[i].width})
          .attr("height", function(d,i){return grid_data[i].height})
          .attr("fill", "#111111")
          .attr("fill-opacity", rect_opacity)
          .attr("stroke", "grey")
          .attr("stroke-width", 1)
          .attr("stroke-opacity", rect_opacity)
          .on("mouseover",  function(d,i) {
            gridContainer.select("#r"+parseInt(d.id))
                          .transition()
                          .duration(30)
                          .attr("fill","green")
                          .attr("fill-opacity", rect_opacity);
          })
          .on("mouseout",  function(d,i) {
            gridContainer.select("#r"+parseInt(d.id))
                          .transition()
                          .duration(1000)
                          .attr("fill","#111111")
                          .attr("fill-opacity", rect_opacity);
          })
          .on("click",  function(d,i) {
            gridContainer.select("#r"+parseInt(d.id))
                          .transition()
                          .duration(1000)
                          .attr("fill","#F11111")
                          .attr("fill-opacity",1);
          })
      }

      function get_random_num(){
        return Math.floor(Math.random()*1000) - 500;
      }

      function init_plant(){
        var _root = new Array();
        // to do : create new point with the help of an angle
        //var _omega = -25 * Math.PI / 180; length * Math.cos(acc.state.theta)
        var _start = {"x":w/2, "y":h};
        var _end = { "x": _start.x + get_random_num(), "y": _start.y - branch_length}; 
        _root.push(_start);
        _root.push(_end);

        plant_data[0] = new Object();
        plant_data[0]["id"] = 0;
        plant_data[0]["branch"] = _root;
        plant_data[0]["generation"] = 0;
        plant_data[0]["children"] = [1,2];
        plant_data[0]["parent"] = -1;
        branch_count++;

        branch_queue.push(0);
      }

      function create_branches(object){
        for (i in object.children){
          child = object.children[i];
          plant_data[child] = new Object();
          plant_data[child]["id"] = child;
          plant_data[child]["branch"] = new_branch(object.id);
          plant_data[child]["generation"] = object.generation +1;
          plant_data[child]["children"] = [child*2+1,child*2+2];
          plant_data[child]["parent"] = object.id;
          branch_count++;

          branch_queue.push(child);
        }
      }

      function new_branch(idx){
        var _branch = new Array();
        var old_end = plant_data[idx].branch[1];
        var _start = { "x": old_end.x, "y": old_end.y}; 
        var _end = { "x": _start.x + get_random_num(), "y": _start.y - branch_length}; 
        _branch.push(_start);
        _branch.push(_end);

        return _branch;
      }

      function draw_plant(){
        for (var i = 0; i < branch_count; i++){
          var lineFunction = d3.svg.line()
            .x(function(d) { return d.x; })
            .y(function(d) { return d.y; })
            .interpolate("basis");

          var plantGraph = plantContainer.append("path")
            .attr("d", lineFunction(plant_data[i].branch))
            .attr("id", "p"+plant_data[i].id)
            .attr("stroke", "green")
            .attr("stroke-width", 10)
            .attr("fill", "none");

          var plant_length = plantGraph.node().getTotalLength();

          plantGraph.attr("stroke-dasharray", plant_length + " " + plant_length)
            .attr("stroke-dashoffset", plant_length)
            .transition()
              .delay(plant_data[i].generation * 3000)
              .duration(3000)
              .ease("basis")
              .attr("stroke-dashoffset", 0);
        }
      }

      function draw_branches(branch_list){
        var _branch_count = branch_list.length;
        for (var i = 0; i < _branch_count; i++){
          idx = branch_list.shift();
          var lineFunction = d3.svg.line()
            .x(function(d) { return d.x; })
            .y(function(d) { return d.y; })
            .interpolate("basis");

          var plantGraph = plantContainer.append("path")
            .attr("d", lineFunction(plant_data[idx].branch))
            .attr("id", "p"+plant_data[idx].id)
            .attr("stroke", "green")
            .attr("stroke-width", 10)
            .attr("fill", "none");

          var plant_length = plantGraph.node().getTotalLength();

          plantGraph.attr("stroke-dasharray", plant_length + " " + plant_length)
            .attr("stroke-dashoffset", plant_length)
            .transition()
              //.delay(plant_data[idx].generation * 3000)
              .duration(3000 + get_random_num())
              .ease("basis")
              .attr("stroke-dashoffset", 0);
        }
      }

      function grow_plant(){
        draw_branches([0])
          var grow = setInterval(function(){
            var _l = branch_queue.length;
            for (var i = 0; i < _l; i++){
              idx = branch_queue.shift();

              create_branches(plant_data[idx]); //create children of last branch

              draw_branches(plant_data[idx].children); // draw children of last branch
              console.log(branch_count);
              if (branch_count > 100){
                window.clearInterval(grow);
                console.log(plant_data);
                break;
              }
            }
            
          }, 3000);
        // console.log(plant_data)

        //}
        //draw_plant();

      }


    </script>
  </body>
</html>