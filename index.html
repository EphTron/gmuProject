<!DOCTYPE html>
<html>
  <head>
    <title>PLANTS HUMANS ROBOTS</title>
    <meta charset="utf-8">
    
    <!-- >>>>>STYLESHEETS<<<<< -->
    <link href="gmuStyle.css" rel="stylesheet" type="text/css">
    
    <!-- >>>>>BOOTSTRAP SCRIPTS<<<<< -->
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery.js"></script>
    
    <!-- >>>>>D3 SCRIPTS<<<<< -->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <!--<script type="text/javascript" src="d3/d3.min.js"></script>-->

  </head>
  <body>
    <div id="gmuArt">
      <div id="gmuPlant">
      </div>
      <div id="gmuGrid">
      </div>
      
    </div>
    <script type="text/javascript">

      // constants
      var padding = 10
      var w = window.innerWidth - padding;
      var h = window.innerHeight- padding;
      var cols = 0;
      var rows = 0;
      var rect_count = 1000;
      var grid_data = new Array();
      var rect_opacity = 0.2;
      var gridContainer = d3.select("#gmuGrid")
          .append("svg")
          .attr("width", w)
          .attr("height", h);

      var grow_time = 3000;
      var max_angle = 3*Math.PI/4;
      var branch_length = w / 15;
      var branch_queue = new Array();
      var plant_data = new Array();
      var branch_count = 0;
      var artContainer = d3.select("#gmuPlant")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

      // run
      init_plant();
      grow_plant();
      
      init_grid(rect_count);
      draw_grid();

      // functions
      function init_grid(r_count){
        var _cols = Math.round(Math.sqrt(r_count * (w/h)));
        var _rows = Math.round(r_count / _cols);

        var _r_w = w / _cols; // calc width of rects
        var _r_h = h / _rows; // calc height of rects

        var idx = 0;
        for(var r = 0; r < _rows; r++){
          for(var c = 0; c < _cols ; c++){
            grid_data[idx] = new Object();
            grid_data[idx]["id"]      = idx;
            grid_data[idx]["width"]   = _r_w;
            grid_data[idx]["pos_y"]   = _r_h * r;
            grid_data[idx]["height"]  = _r_h;
            grid_data[idx]["pos_x"]   = _r_w * c;
            grid_data[idx]["touched"] = 0;
            idx++;
          }
        }
        cols = _cols;
        rows = _rows;
      }

      function draw_grid(){
        var rectGrid = gridContainer.selectAll("rect")
          .data(grid_data)
          .enter()
          .append("rect");

        rectGrid.attr("id", function(d,i){return "r"+i;})
          .attr("x", function(d,i){return grid_data[i].pos_x})
          .attr("y", function(d,i){return grid_data[i].pos_y})
          .attr("width", function(d,i){return grid_data[i].width})
          .attr("height", function(d,i){return grid_data[i].height})
          .attr("fill", "#111111")
          .attr("fill-opacity", rect_opacity)
          .attr("stroke", "grey")
          .attr("stroke-width", 1)
          .attr("stroke-opacity", rect_opacity)
          .on("mouseover",  function(d,i) {
            gridContainer.select("#r"+parseInt(d.id))
                          .transition()
                          .duration(30)
                          .attr("fill","green")
                          .attr("fill-opacity", rect_opacity);
            d.touched++;
            console.log(d.touched)
          })
          .on("mouseout",  function(d,i) {
            gridContainer.select("#r"+parseInt(d.id))
                          .transition()
                          .duration(1000)
                          .attr("fill","#111111")
                          .attr("fill-opacity", rect_opacity);
          })
          .on("click",  function(d,i) {
            gridContainer.select("#r"+parseInt(d.id))
                          .transition()
                          .duration(1000)
                          .attr("fill","#F11111")
                          .attr("fill-opacity",1);
          })
      }

      function init_plant(){
        var _omega =   -Math.PI/2;//max_angle * Math.random() + (max_angle/2) ;
        var _start = { "x":w/2, 
                       "y":h};
        var _middle = { "x": _start.x + branch_length * Math.cos(_omega) * 0.5,
                        "y": _start.y + (branch_length * Math.sin(_omega) * 0.5) + 20}; 
        var _end = { "x": _start.x + 2.5* branch_length * Math.cos(_omega), 
                     "y": _start.y + 1.5* branch_length * Math.sin(_omega)}; 

        var _root = new Array();
        _root.push(_start);
        _root.push(_middle)
        _root.push(_end);

        plant_data[0] = new Object();
        plant_data[0]["id"] = 0;
        plant_data[0]["branch"] = _root;
        plant_data[0]["angle"] = _omega;
        plant_data[0]["generation"] = 0;
        plant_data[0]["children"] = [1,2];
        plant_data[0]["parent"] = -1;
        branch_count++;

        branch_queue.push(0);
      }

      function create_branches(object){
        for (i in object.children){
          child = object.children[i];
          plant_data[child] = new Object();
          
          var _old_end = plant_data[object.id].branch[2];
          var _old_omega = plant_data[object.id].angle;
          var _omega = _old_omega + Math.random() * max_angle - (max_angle / 2); 
          var _start = { "x": _old_end.x, 
                         "y": _old_end.y};
          var _test_test = find_hotspot(_start, grid_data);
          var _middle = { "x": _start.x + branch_length * Math.cos(_omega/2) * 0.5,
                          "y": _start.y + (branch_length * Math.sin(_omega/2) * 0.5) + (Math.random() * 20) - 10 }; 
          var _end = { "x": _start.x + branch_length * Math.cos(_omega),
                       "y": _start.y + branch_length * Math.sin(_omega)}; 
          var _branch = new Array();
          _branch.push(_start);
          _branch.push(_middle);
          _branch.push(_end);

          plant_data[child]["id"] = child;
          plant_data[child]["branch"] = _branch;
          plant_data[child]["angle"] = _omega;
          plant_data[child]["generation"] = object.generation +1;
          plant_data[child]["children"] = [child*2+1,child*2+2];
          plant_data[child]["parent"] = object.id;
          branch_count++;

          branch_queue.push(child);
        }
      }

      function find_hotspot(location, data){
        var _location_on_grid_x = Math.floor(location.x / data[0].width);
        var _location_on_grid_y = Math.floor(location.y / data[0].height);
        var _location_rect_id = (_location_on_grid_y) * cols + _location_on_grid_x;
        gridContainer.select("#r"+parseInt(_location_rect_id))
                          .transition()
                          .duration(100)
                          .attr("fill","#1111F1")
                          .attr("fill-opacity",0.5);


        var _point = { "x": 0, 
                       "y": 0};
        return _point
      }

      function draw_branches(branch_list){
        var _branch_count = branch_list.length;
        for (var i = 0; i < _branch_count; i++){
          idx = branch_list.shift();
          var lineFunction = d3.svg.line()
            .x(function(d) { return d.x; })
            .y(function(d) { return d.y; })
            .interpolate("basis");

          var plantGraph = artContainer.append("path")
            .attr("d", lineFunction(plant_data[idx].branch))
            .attr("id", "p"+plant_data[idx].id)
            .attr("stroke", "green")
            .attr("stroke-width", 5 - (plant_data[idx].generation) * 0.4)
            .attr("fill", "none");

          var plant_length = plantGraph.node().getTotalLength();

          plantGraph.attr("stroke-dasharray", plant_length + " " + plant_length)
            .attr("stroke-dashoffset", plant_length)
            .transition()
              //.delay(plant_data[idx].generation * 3000)
              .duration(grow_time)
              .ease("basis")
              .attr("stroke-dashoffset", 0);
        }
      }

      function grow_plant(){
        draw_branches([0])
          var grow = setInterval(function(){
            var _l = branch_queue.length;
            for (var i = 0; i < _l; i++){
              idx = branch_queue.shift();

              create_branches(plant_data[idx]); //create children of last branch

              draw_branches(plant_data[idx].children); // draw children of last branch
              if (branch_count > 100){
                window.clearInterval(grow);
                break;
              }
            }
            
          }, grow_time)

      }


    </script>
  </body>
</html>